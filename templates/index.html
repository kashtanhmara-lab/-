<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–°–∏—Å—Ç–µ–º–∞ –∏–Ω—Ç–µ–ª–ª–µ–∫—Ç—É–∞–ª—å–Ω–æ–≥–æ –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è –≤—ã–µ–∑–¥–æ–≤ –¥–ª—è –ø—Ä–µ–¥–ø—Ä–∏–Ω–∏–º–∞—Ç–µ–ª–µ–π</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.css" />
    <style>
        /* === –û–°–ù–û–í–ù–´–ï –°–¢–ò–õ–ò === */
        body {
            overflow-x: hidden;
        }
        
        #map {
            height: 600px;
            width: 100%;
            border-radius: 8px;
        }
        
        .sidebar-container {
            height: calc(100vh - 100px);
            overflow-y: auto;
            padding-right: 10px;
        }
        
        /* === –ö–û–ú–ü–û–ù–ï–ù–¢–´ –°–ü–ò–°–ö–û–í === */
        .address-list-container,
        .schedule-container {
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid #e0e0e0;
            border-radius: 5px;
            padding: 10px;
            background: #f8f9fa;
        }
        
        .address-item,
        .schedule-item {
            padding: 10px;
            border: 1px solid #e0e0e0;
            border-radius: 5px;
            margin-bottom: 8px;
            background: white;
            position: relative;
        }
        
        .address-item {
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .address-item:hover {
            background-color: #f0f8ff;
            border-color: #007bff;
        }
        
        /* === –°–¢–ò–õ–ò –î–õ–Ø –¢–ò–ü–û–í –ö–õ–ò–ï–ù–¢–û–í === */
        .address-item.vip,
        .schedule-item.vip {
            border-left: 4px solid #ffc107;
            background-color: #fffaf0;
        }
        
        .address-item.standard,
        .schedule-item.standard {
            border-left: 4px solid #6c757d;
        }
        
        /* === –ó–ê–ì–û–õ–û–í–ö–ò –ò –î–ï–¢–ê–õ–ò === */
        .address-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 5px;
        }
        
        .address-details {
            font-size: 0.85em;
        }
        
        /* === –ö–ù–û–ü–ö–ò –£–î–ê–õ–ï–ù–ò–Ø === */
        .delete-btn {
            position: absolute;
            top: 75px;
            right: 5px;
            background: #dc3545;
            color: white;
            border: none;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            font-size: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            opacity: 0.7;
            transition: opacity 0.3s ease;
        }
        
        .delete-btn:hover {
            opacity: 1;
            background: #c82333;
        }
        
        /* === –†–ê–°–ü–ò–°–ê–ù–ò–ï === */
        .schedule-item {
            display: flex;
        }
        
        .schedule-order {
            background: #007bff;
            color: white;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 10px;
            font-weight: bold;
            flex-shrink: 0;
        }
        
        .schedule-content {
            flex: 1;
            min-width: 0;
        }
        
        .schedule-address {
            word-wrap: break-word;
            overflow-wrap: break-word;
        }
        
        /* === –°–¢–ê–¢–ò–°–¢–ò–ö–ê === */
        .stat-number {
            font-size: 1.5em;
            font-weight: bold;
            color: #007bff;
        }
        
        /* === –£–í–ï–î–û–ú–õ–ï–ù–ò–Ø === */
        .alert-container {
            position: fixed;
            top: 80px;
            right: 20px;
            z-index: 1000;
            min-width: 300px;
            max-width: 400px;
        }
        
        /* === –ú–ê–†–ö–ï–†–´ –ö–ê–†–¢–´ === */
        .custom-marker {
            background: white;
            border: 3px solid;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 12px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
        }
        
        .location-status {
            background: #e3f2fd;
            border: 1px solid #2196f3;
            border-radius: 5px;
            padding: 8px;
            margin-bottom: 10px;
            font-size: 0.9em;
        }
        
        /* === –°–ö–†–´–¢–ò–ï –ê–¢–¢–†–ò–ë–£–¶–ò–ò === */
        .leaflet-control-attribution img,
        .leaflet-control-attribution a[href*="flag"],
        .leaflet-control-attribution .leaflet-attribution-flag {
            display: none !important;
        }
        
        /* === –°–¢–ò–õ–ò –î–õ–Ø ROUTING MACHINE === */
        .leaflet-routing-container {
            background: white;
            width: 320px;
            max-height: 400px;
            overflow-y: auto;
        }
        
        /* === –ö–ê–°–¢–û–ú–ù–´–ï –°–ö–†–û–õ–õ–ë–ê–†–´ === */
        .address-list-container::-webkit-scrollbar,
        .schedule-container::-webkit-scrollbar,
        .sidebar-container::-webkit-scrollbar {
            width: 8px;
        }
        
        .address-list-container::-webkit-scrollbar-track,
        .schedule-container::-webkit-scrollbar-track,
        .sidebar-container::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }
        
        .address-list-container::-webkit-scrollbar-thumb,
        .schedule-container::-webkit-scrollbar-thumb,
        .sidebar-container::-webkit-scrollbar-thumb {
            background: #c1c1c1;
            border-radius: 4px;
        }
        
        .address-list-container::-webkit-scrollbar-thumb:hover,
        .schedule-container::-webkit-scrollbar-thumb:hover,
        .sidebar-container::-webkit-scrollbar-thumb:hover {
            background: #a8a8a8;
        }
    </style>
</head>
<body>
    <!-- === –ù–ê–í–ò–ì–ê–¶–ò–Ø === -->
    <nav class="navbar navbar-dark bg-primary">
        <div class="container-fluid">
            <span class="navbar-brand mb-0 h1">üó∫Ô∏è –ü–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫ –º–∞—Ä—à—Ä—É—Ç–æ–≤ (Leaflet)</span>
        </div>
    </nav>

    <!-- === –ö–û–ù–¢–ï–ô–ù–ï–† –î–õ–Ø –£–í–ï–î–û–ú–õ–ï–ù–ò–ô === -->
    <div class="alert-container" id="alertContainer"></div>

    <!-- === –û–°–ù–û–í–ù–û–ô –ö–û–ù–¢–ï–ù–¢ === -->
    <div class="container-fluid mt-3">
        <div class="row">
            <!-- === –ë–û–ö–û–í–ê–Ø –ü–ê–ù–ï–õ–¨ === -->
            <div class="col-md-4">
                <div class="sidebar-container">
                    <!-- –ë–ª–æ–∫ –±—ã—Å—Ç—Ä–æ–≥–æ —Å—Ç–∞—Ä—Ç–∞ -->
                    <div class="card mb-3">
                        <div class="card-header bg-success text-white">
                            <h5 class="mb-0">üöÄ –ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç</h5>
                        </div>
                        <div class="card-body">
                            <p class="card-text">–í—ã–±–µ—Ä–∏—Ç–µ –¥–æ 15 —Ç–æ—á–µ–∫ –¥–ª—è –ø–æ—Å—Ç—Ä–æ–µ–Ω–∏—è –æ–ø—Ç–∏–º–∞–ª—å–Ω–æ–≥–æ –º–∞—Ä—à—Ä—É—Ç–∞ —Å —É—á–µ—Ç–æ–º –≤—Ä–µ–º–µ–Ω–∏ —Ä–∞–±–æ—Ç—ã –∏ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–∞ –∫–ª–∏–µ–Ω—Ç–æ–≤.</p>
                            <div class="location-status" id="locationStatus">
                                <strong>üìç –¢–µ–∫—É—â–µ–µ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ:</strong><br>
                                <span id="locationText">–û–ø—Ä–µ–¥–µ–ª—è–µ–º...</span>
                            </div>
                            <small class="text-muted" id="fileInfo">–ó–∞–≥—Ä—É–∑–∫–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ —Ñ–∞–π–ª–µ...</small>
                        </div>
                    </div>

                    <!-- –®–∞–≥ 1: –í—ã–±–æ—Ä —Ç–æ—á–µ–∫ -->
                    <div class="card mb-3">
                        <div class="card-header">
                            <h5 class="mb-0">üìç –®–∞–≥ 1: –í—ã–±–æ—Ä —Ç–æ—á–µ–∫</h5>
                        </div>
                        <div class="card-body">
                            <div class="mb-3">
                                <label class="form-label">–ü–æ–∏—Å–∫ –∞–¥—Ä–µ—Å–∞:</label>
                                <input type="text" class="form-control" id="addressSearch" placeholder="–í–≤–µ–¥–∏—Ç–µ –∞–¥—Ä–µ—Å –¥–ª—è –ø–æ–∏—Å–∫–∞...">
                            </div>
                            
                            <div class="mb-3">
                                <label class="form-label">–§–∏–ª—å—Ç—Ä –ø–æ —Ç–∏–ø—É –∫–ª–∏–µ–Ω—Ç–∞:</label>
                                <select class="form-select" id="clientTypeFilter">
                                    <option value="all">–í—Å–µ –∫–ª–∏–µ–Ω—Ç—ã</option>
                                    <option value="vip">VIP –∫–ª–∏–µ–Ω—Ç—ã</option>
                                    <option value="standard">–°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ –∫–ª–∏–µ–Ω—Ç—ã</option>
                                </select>
                            </div>

                            <div class="address-list-container">
                                <div class="address-list" id="addressList">
                                    <div class="text-center py-3">
                                        <div class="spinner-border text-primary" role="status">
                                            <span class="visually-hidden">–ó–∞–≥—Ä—É–∑–∫–∞ –∞–¥—Ä–µ—Å–æ–≤...</span>
                                        </div>
                                        <p class="mt-2">–ó–∞–≥—Ä—É–∑–∫–∞ –∞–¥—Ä–µ—Å–æ–≤ –∏–∑ —Ñ–∞–π–ª–∞...</p>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="mt-3">
                                <button id="updateLocationBtn" class="btn btn-outline-info btn-sm w-100">
                                    üîÑ –û–±–Ω–æ–≤–∏—Ç—å –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ
                                </button>
                            </div>
                            
                            <div class="mt-3">
                                <small class="text-muted">–í—ã–±—Ä–∞–Ω–æ: <span id="selectedCount">0</span>/15 —Ç–æ—á–µ–∫</small>
                                <div class="progress mt-1">
                                    <div id="selectionProgress" class="progress-bar" role="progressbar" style="width: 0%"></div>
                                </div>
                            </div>

                            <div class="mt-2">
                                <button id="clearSelectionBtn" class="btn btn-outline-secondary btn-sm w-100">
                                    üßπ –û—á–∏—Å—Ç–∏—Ç—å –≤—ã–±–æ—Ä
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- –ò–º–ø–æ—Ä—Ç –Ω–æ–≤—ã—Ö —Ç–æ—á–µ–∫ -->
                    <div class="card mb-3">
                        <div class="card-header">
                            <h5 class="mb-0">üì• –ò–º–ø–æ—Ä—Ç –Ω–æ–≤—ã—Ö —Ç–æ—á–µ–∫</h5>
                        </div>
                        <div class="card-body">
                            <div class="mb-3">
                                <label class="form-label">–ó–∞–≥—Ä—É–∑–∏—Ç—å CSV —Ñ–∞–π–ª:</label>
                                <input type="file" class="form-control" id="csvFile" accept=".csv">
                                <small class="form-text text-muted">
                                    –§–æ—Ä–º–∞—Ç CSV: –ê–¥—Ä–µ—Å –æ–±—ä–µ–∫—Ç–∞, –ì–µ–æ–≥—Ä–∞—Ñ–∏—á–µ—Å–∫–∞—è —à–∏—Ä–æ—Ç–∞, –ì–µ–æ–≥—Ä–∞—Ñ–∏—á–µ—Å–∫–∞—è –¥–æ–ª–≥–æ—Ç–∞, 
                                    –í—Ä–µ–º—è –Ω–∞—á–∞–ª–∞ —Ä–∞–±–æ—á–µ–≥–æ –¥–Ω—è, –í—Ä–µ–º—è –æ–∫–æ–Ω—á–∞–Ω–∏—è —Ä–∞–±–æ—á–µ–≥–æ –¥–Ω—è, –í—Ä–µ–º—è –Ω–∞—á–∞–ª–∞ –æ–±–µ–¥–∞, –í—Ä–µ–º—è –æ–∫–æ–Ω—á–∞–Ω–∏—è –æ–±–µ–¥–∞,–£—Ä–æ–≤–µ–Ω—å –∫–ª–∏–µ–Ω—Ç–∞ 
                                </small>
                            </div>
                            <button class="btn btn-outline-primary btn-sm w-100 mb-3" id="uploadCsvBtn">
                                üì§ –ó–∞–≥—Ä—É–∑–∏—Ç—å CSV
                            </button>
                            
                            <hr>
                            
                            <div class="mb-3">
                                <label class="form-label">–î–æ–±–∞–≤–∏—Ç—å –æ–¥–Ω—É —Ç–æ—á–∫—É:</label>
                                <input type="text" class="form-control mb-2" id="newAddress" placeholder="–ê–¥—Ä–µ—Å">
                                <div class="row mb-2">
                                    <div class="col-6">
                                        <input type="number" class="form-control" id="newLat" placeholder="–®–∏—Ä–æ—Ç–∞" step="any">
                                    </div>
                                    <div class="col-6">
                                        <input type="number" class="form-control" id="newLon" placeholder="–î–æ–ª–≥–æ—Ç–∞" step="any">
                                    </div>
                                </div>
                                <select class="form-select mb-2" id="newClientType">
                                    <option value="VIP">VIP</option>
                                    <option value="Standard">Standard</option>
                                </select>
                            </div>
                            <button class="btn btn-outline-success btn-sm w-100" id="addSingleAddressBtn">
                                ‚ûï –î–æ–±–∞–≤–∏—Ç—å —Ç–æ—á–∫—É
                            </button>
                            
                            <div class="mt-3">
                                <div id="importStatus"></div>
                            </div>
                        </div>
                    </div>

                    <!-- –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ç–æ—á–∫–∞–º–∏ -->
                    <div class="card mb-3">
                        <div class="card-header">
                            <h5 class="mb-0">üóëÔ∏è –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ç–æ—á–∫–∞–º–∏</h5>
                        </div>
                        <div class="card-body">
                            <div class="mb-3">
                                <label class="form-label">–£–¥–∞–ª–∏—Ç—å —Ç–æ—á–∫—É –∏–∑ —Å–ø–∏—Å–∫–∞:</label>
                                <select class="form-select" id="deleteAddressSelect">
                                    <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –∞–¥—Ä–µ—Å –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è</option>
                                </select>
                            </div>
                            <button class="btn btn-outline-danger btn-sm w-100 mb-2" id="deleteAddressBtn" disabled>
                                üóëÔ∏è –£–¥–∞–ª–∏—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—É—é —Ç–æ—á–∫—É
                            </button>
                            <button class="btn btn-outline-warning btn-sm w-100" id="deleteAllAddressesBtn">
                                üóëÔ∏è –£–¥–∞–ª–∏—Ç—å –≤—Å–µ —Ç–æ—á–∫–∏
                            </button>
                            <div class="mt-2">
                                <small class="text-muted">–í—Å–µ–≥–æ —Ç–æ—á–µ–∫ –≤ –±–∞–∑–µ: <span id="totalAddressesCount">0</span></small>
                            </div>
                        </div>
                    </div>

                    <!-- –®–∞–≥ 2: –ü–æ—Å—Ç—Ä–æ–µ–Ω–∏–µ –º–∞—Ä—à—Ä—É—Ç–∞ -->
                    <div class="card mb-3">
                        <div class="card-header">
                            <h5 class="mb-0">üéØ –®–∞–≥ 2: –ü–æ—Å—Ç—Ä–æ–µ–Ω–∏–µ –º–∞—Ä—à—Ä—É—Ç–∞</h5>
                        </div>
                        <div class="card-body">
                            <div class="form-check form-switch mb-3">
                                <input class="form-check-input" type="checkbox" id="avoidTraffic" checked>
                                <label class="form-check-label" for="avoidTraffic">
                                    üö¶ –£—á–∏—Ç—ã–≤–∞—Ç—å –ø—Ä–æ–±–∫–∏ –∏ –î–¢–ü (TomTom)
                                </label>
                            </div>
                            <button class="btn btn-primary w-100" id="optimizeBtn" disabled>
                                <span class="spinner-border spinner-border-sm d-none" id="optimizeSpinner"></span>
                                üöÄ –ü–æ—Å—Ç—Ä–æ–∏—Ç—å –æ–ø—Ç–∏–º–∞–ª—å–Ω—ã–π –º–∞—Ä—à—Ä—É—Ç
                            </button>
                        </div>
                    </div>

                    <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø—Ä–æ–±–∫–∞—Ö -->
                    <div class="traffic-info alert alert-info mt-3" id="trafficInfo" style="display: none;">
                        <h6>üö¶ –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø—Ä–æ–±–∫–∞—Ö:</h6>
                        <div id="trafficDetails"></div>
                    </div>

                    <!-- –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –º–∞—Ä—à—Ä—É—Ç–∞ -->
                    <div class="card results-card" id="resultsCard" style="display: none;">
                        <div class="card-header bg-info text-white">
                            <h5 class="mb-0">üìã –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –º–∞—Ä—à—Ä—É—Ç–∞</h5>
                        </div>
                        <div class="card-body">
                            <div class="route-summary mb-3">
                                <div class="row text-center">
                                    <div class="col-4">
                                        <div class="stat-number" id="totalPoints">0</div>
                                        <small class="text-muted">–¢–æ—á–µ–∫</small>
                                    </div>
                                    <div class="col-4">
                                        <div class="stat-number" id="totalDistance">0</div>
                                        <small class="text-muted">–ö–º</small>
                                    </div>
                                    <div class="col-4">
                                        <div class="stat-number" id="totalTime">0</div>
                                        <small class="text-muted">–ß–∞—Å–æ–≤</small>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="schedule-container">
                                <h6>–†–∞—Å–ø–∏—Å–∞–Ω–∏–µ –ø–æ—Å–µ—â–µ–Ω–∏–π:</h6>
                                <div class="schedule" id="schedule">
                                    <!-- –†–∞—Å–ø–∏—Å–∞–Ω–∏–µ –±—É–¥–µ—Ç –∑–¥–µ—Å—å -->
                                </div>
                            </div>
                            
                            <div class="mt-3">
                                <button class="btn btn-success w-100" id="exportBtn">
                                    üì§ –≠–∫—Å–ø–æ—Ä—Ç –≤ CSV
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- === –ö–ê–†–¢–ê === -->
            <div class="col-md-8">
                <div class="card h-100">
                    <div class="card-header">
                        <h5 class="mb-0">üó∫Ô∏è –ö–∞—Ä—Ç–∞ –º–∞—Ä—à—Ä—É—Ç–∞ (Leaflet)</h5>
                    </div>
                    <div class="card-body p-0">
                        <div id="map">
                            <div class="text-center py-5">
                                <div class="spinner-border text-primary" role="status">
                                    <span class="visually-hidden">–ó–∞–≥—Ä—É–∑–∫–∞ –∫–∞—Ä—Ç—ã...</span>
                                </div>
                                <p class="mt-2">–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–∞—Ä—Ç—ã...</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- === –ë–ò–ë–õ–ò–û–¢–ï–ö–ò === -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.js"></script>
    
    <script>
        // === –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø –ò –ì–õ–û–ë–ê–õ–¨–ù–´–ï –ü–ï–†–ï–ú–ï–ù–ù–´–ï ===
        const MAX_POINTS = 15;
        
        let selectedPoints = new Map(); // –¢–µ–ø–µ—Ä—å —Ö—Ä–∞–Ω–∏–º –æ–±—ä–µ–∫—Ç—ã –∞–¥—Ä–µ—Å–æ–≤
        let userLocation = [47.222, 39.715]; // –¶–µ–Ω—Ç—Ä –†–æ—Å—Ç–æ–≤–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
        let map = null;
        let routeLayer = null;
        let addressMarkers = [];
        let userLocationMarker = null;
        let routingControl = null;
        let allAddresses = [];

        // === –£–¢–ò–õ–ò–¢–´ ===
        
        /**
         * –ü–æ–∫–∞–∑–∞—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
         * @param {string} message - –¢–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è
         * @param {string} type - –¢–∏–ø —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è (info, success, warning, danger)
         */
        function showAlert(message, type = 'info') {
            const alertContainer = document.getElementById('alertContainer');
            const alertId = 'alert-' + Date.now();
            
            const alertDiv = document.createElement('div');
            alertDiv.id = alertId;
            alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
            alertDiv.innerHTML = `
                ${type === 'success' ? '‚úÖ' : type === 'warning' ? '‚ö†Ô∏è' : type === 'danger' ? '‚ùå' : '‚ÑπÔ∏è'} 
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            
            alertContainer.appendChild(alertDiv);
            
            // –ê–≤—Ç–æ—É–¥–∞–ª–µ–Ω–∏–µ —á–µ—Ä–µ–∑ 5 —Å–µ–∫—É–Ω–¥
            setTimeout(() => {
                const alert = document.getElementById(alertId);
                if (alert) alert.remove();
            }, 5000);
        }

        /**
         * –ü–æ–ª—É—á–∏—Ç—å —Ç–µ–∫—Å—Ç–æ–≤–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ —É—Ä–æ–≤–Ω—è –ø—Ä–æ–±–æ–∫
         * @param {string} level - –£—Ä–æ–≤–µ–Ω—å –ø—Ä–æ–±–æ–∫
         * @returns {string} –¢–µ–∫—Å—Ç–æ–≤–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ
         */
        function getTrafficLevelText(level) {
            const levels = {
                'low': '–ù–∏–∑–∫–∏–µ',
                'medium': '–°—Ä–µ–¥–Ω–∏–µ', 
                'high': '–í—ã—Å–æ–∫–∏–µ',
                'very_high': '–û—á–µ–Ω—å –≤—ã—Å–æ–∫–∏–µ'
            };
            return levels[level] || level;
        }

        // === –†–ê–ë–û–¢–ê –° –ö–ê–†–¢–û–ô ===
        
        /**
         * –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–∞—Ä—Ç—ã Leaflet
         */
        function initMap() {
            map = L.map('map').setView(userLocation, 12);

            // –î–æ–±–∞–≤–ª—è–µ–º –±–µ—Å–ø–ª–∞—Ç–Ω—ã–µ —Ç–∞–π–ª—ã OpenStreetMap
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '¬© OpenStreetMap contributors',
                maxZoom: 18
            }).addTo(map);

            console.log('üó∫Ô∏è –ö–∞—Ä—Ç–∞ Leaflet –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–∞');
            showAlert('–ö–∞—Ä—Ç–∞ –∑–∞–≥—Ä—É–∂–µ–Ω–∞', 'success');
            
            // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
            getUserLocation();
        }

        /**
         * –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
         */
        function getUserLocation() {
            if (navigator.geolocation) {
                document.getElementById('locationText').textContent = '–û–ø—Ä–µ–¥–µ–ª—è–µ–º –≤–∞—à–µ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ...';
                showAlert('–û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –≤–∞—à–µ–≥–æ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏—è...', 'info');
                
                navigator.geolocation.getCurrentPosition(
                    function(position) {
                        userLocation = [position.coords.latitude, position.coords.longitude];
                        console.log("üìç –ú–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–æ:", userLocation);
                        
                        // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–µ–∫—Å—Ç –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏—è
                        document.getElementById('locationText').innerHTML = 
                            `<strong>–®–∏—Ä–æ—Ç–∞:</strong> ${userLocation[0].toFixed(4)}<br>` +
                            `<strong>–î–æ–ª–≥–æ—Ç–∞:</strong> ${userLocation[1].toFixed(4)}`;
                        
                        showAlert('–í–∞—à–µ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–æ! –ú–∞—Ä—à—Ä—É—Ç –±—É–¥–µ—Ç –ø–æ—Å—Ç—Ä–æ–µ–Ω –æ—Ç—Å—é–¥–∞.', 'success');
                        
                        // –û–±–Ω–æ–≤–ª—è–µ–º –º–∞—Ä–∫–µ—Ä –Ω–∞ –∫–∞—Ä—Ç–µ
                        updateUserLocationMarker();
                        
                        // –ü–µ—Ä–µ–º–µ—â–∞–µ–º –∫–∞—Ä—Ç—É –Ω–∞ –Ω–æ–≤–æ–µ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ
                        if (map) {
                            map.setView(userLocation, 13);
                        }
                    },
                    function(error) {
                        console.log("–û—à–∏–±–∫–∞ –≥–µ–æ–ª–æ–∫–∞—Ü–∏–∏:", error);
                        document.getElementById('locationText').innerHTML = 
                            '–ù–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ. –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Ü–µ–Ω—Ç—Ä –†–æ—Å—Ç–æ–≤–∞-–Ω–∞-–î–æ–Ω—É.<br>' +
                            `<strong>–®–∏—Ä–æ—Ç–∞:</strong> ${userLocation[0].toFixed(4)}<br>` +
                            `<strong>–î–æ–ª–≥–æ—Ç–∞:</strong> ${userLocation[1].toFixed(4)}`;
                        showAlert('–ù–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ. –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Ü–µ–Ω—Ç—Ä –≥–æ—Ä–æ–¥–∞.', 'warning');
                        
                        // –í—Å–µ —Ä–∞–≤–Ω–æ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –º–∞—Ä–∫–µ—Ä —Ü–µ–Ω—Ç—Ä–∞
                        updateUserLocationMarker();
                    },
                    {
                        enableHighAccuracy: true,
                        timeout: 10000,
                        maximumAge: 60000
                    }
                );
            } else {
                document.getElementById('locationText').innerHTML = 
                    '–ì–µ–æ–ª–æ–∫–∞—Ü–∏—è –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è –±—Ä–∞—É–∑–µ—Ä–æ–º. –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Ü–µ–Ω—Ç—Ä –†–æ—Å—Ç–æ–≤–∞-–Ω–∞-–î–æ–Ω—É.<br>' +
                    `<strong>–®–∏—Ä–æ—Ç–∞:</strong> ${userLocation[0].toFixed(4)}<br>` +
                    `<strong>–î–æ–ª–≥–æ—Ç–∞:</strong> ${userLocation[1].toFixed(4)}`;
                showAlert('–ì–µ–æ–ª–æ–∫–∞—Ü–∏—è –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è –±—Ä–∞—É–∑–µ—Ä–æ–º', 'warning');
                updateUserLocationMarker();
            }
        }

        /**
         * –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –º–∞—Ä–∫–µ—Ä–∞ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
         */
        function updateUserLocationMarker() {
            // –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–π –º–∞—Ä–∫–µ—Ä
            if (userLocationMarker) {
                map.removeLayer(userLocationMarker);
            }
            
            // –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—ã–π –º–∞—Ä–∫–µ—Ä
            userLocationMarker = L.marker(userLocation)
                .addTo(map)
                .bindPopup('üìç <strong>–í–∞—à–µ —Ç–µ–∫—É—â–µ–µ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ</strong><br>–û—Ç—Å—é–¥–∞ –±—É–¥–µ—Ç –ø–æ—Å—Ç—Ä–æ–µ–Ω –º–∞—Ä—à—Ä—É—Ç')
                .openPopup();
        }

        // === –†–ê–ë–û–¢–ê –° –ê–î–†–ï–°–ê–ú–ò ===
        
        /**
         * –ó–∞–≥—Ä—É–∑–∫–∞ –∞–¥—Ä–µ—Å–æ–≤ –∏–∑ —Ñ–∞–π–ª–∞
         */
        async function loadAddresses() {
            try {
                // –ó–∞–≥—Ä—É–∂–∞–µ–º CSV —Ñ–∞–π–ª
                const response = await fetch('addresses.csv');
                
                if (!response.ok) {
                    throw new Error(`–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–∞: ${response.status}`);
                }
                
                const csvText = await response.text();
                const addresses = parseCSV(csvText);
                
                allAddresses = addresses;
                populateAddressList(addresses);
                populateDeleteAddressSelect(addresses);
                updateFileInfo(addresses.length);
                showAlert(`–ó–∞–≥—Ä—É–∂–µ–Ω–æ ${addresses.length} –∞–¥—Ä–µ—Å–æ–≤ –∏–∑ —Ñ–∞–π–ª–∞`, 'success');
                
            } catch (error) {
                console.error('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∞–¥—Ä–µ—Å–æ–≤:', error);
                showAlert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∞–¥—Ä–µ—Å–æ–≤: ' + error.message, 'danger');
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ
                document.getElementById('addressList').innerHTML = `
                    <div class="alert alert-danger">
                        <strong>‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–∞</strong><br>
                        ${error.message}<br>
                        <small>–£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ —Ñ–∞–π–ª addresses.csv —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –≤ –∫–æ—Ä–Ω–µ–≤–æ–π –ø–∞–ø–∫–µ</small>
                    </div>
                `;
            }
        }

        /**
         * –ü–∞—Ä—Å–∏–Ω–≥ CSV —Ñ–∞–π–ª–∞ —Å –Ω–æ–≤—ã–º —Ñ–æ—Ä–º–∞—Ç–æ–º
         * @param {string} csvText - –¢–µ–∫—Å—Ç CSV —Ñ–∞–π–ª–∞
         * @returns {Array} –ú–∞—Å—Å–∏–≤ –æ–±—ä–µ–∫—Ç–æ–≤ –∞–¥—Ä–µ—Å–æ–≤
         */
        function parseCSV(csvText) {
            const lines = csvText.split('\n').filter(line => line.trim() !== '');
            const addresses = [];
            
            // –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫
            for (let i = 1; i < lines.length; i++) {
                const line = lines[i];
                
                // –£–ª—É—á—à–µ–Ω–Ω—ã–π –ø–∞—Ä—Å–∏–Ω–≥ CSV —Å —É—á–µ—Ç–æ–º –∫–∞–≤—ã—á–µ–∫
                const parts = [];
                let currentPart = '';
                let inQuotes = false;
                
                for (let j = 0; j < line.length; j++) {
                    const char = line[j];
                    
                    if (char === '"') {
                        inQuotes = !inQuotes;
                    } else if (char === ',' && !inQuotes) {
                        parts.push(currentPart.trim());
                        currentPart = '';
                    } else {
                        currentPart += char;
                    }
                }
                parts.push(currentPart.trim());
                
                // –û—á–∏—â–∞–µ–º –∫–∞–≤—ã—á–∫–∏ –µ—Å–ª–∏ –µ—Å—Ç—å
                const cleanParts = parts.map(part => part.replace(/^"|"$/g, ''));
                
                if (cleanParts.length >= 8) {
                    // –ò—Å–ø—Ä–∞–≤–ª—è–µ–º –æ–ø–µ—á–∞—Ç–∫—É "Standart" -> "Standard"
                    let clientType = cleanParts[7] || 'Standard';
                    if (clientType === 'Standart') {
                        clientType = 'Standard';
                    }
                    
                    const address = {
                        id: i,
                        address: cleanParts[0] || `–ê–¥—Ä–µ—Å ${i}`,
                        lat: parseFloat(cleanParts[1]) || (47.222 + (Math.random() - 0.5) * 0.1),
                        lon: parseFloat(cleanParts[2]) || (39.715 + (Math.random() - 0.5) * 0.1),
                        work_time_start: cleanParts[3] || '09:00',
                        work_time_end: cleanParts[4] || '18:00',
                        lunch_start: cleanParts[5] || '13:00',
                        lunch_end: cleanParts[6] || '14:00',
                        client_type: clientType,
                        visit_duration: clientType === 'VIP' ? '45' : '30'
                    };
                    
                    addresses.push(address);
                } else {
                    console.warn(`–ü—Ä–æ–ø—É—â–µ–Ω–∞ —Å—Ç—Ä–æ–∫–∞ ${i}: –Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–∞–Ω–Ω—ã—Ö`, cleanParts);
                }
            }
            
            return addresses;
        }

        /**
         * –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ —Ñ–∞–π–ª–µ
         * @param {number} count - –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∞–¥—Ä–µ—Å–æ–≤
         */
        function updateFileInfo(count) {
            const fileInfo = document.getElementById('fileInfo');
            if (fileInfo) {
                fileInfo.textContent = `–ó–∞–≥—Ä—É–∂–µ–Ω–æ ${count} –∞–¥—Ä–µ—Å–æ–≤ –∏–∑ —Ñ–∞–π–ª–∞ addresses.csv`;
            }
        }

        /**
         * –ó–∞–ø–æ–ª–Ω–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ –∞–¥—Ä–µ—Å–æ–≤
         * @param {Array} addresses - –ú–∞—Å—Å–∏–≤ –∞–¥—Ä–µ—Å–æ–≤
         */
        function populateAddressList(addresses) {
            const container = document.getElementById('addressList');
            container.innerHTML = '';

            if (addresses.length === 0) {
                container.innerHTML = `
                    <div class="alert alert-warning">
                        <strong>‚ö†Ô∏è –§–∞–π–ª –ø—É—Å—Ç</strong><br>
                        –§–∞–π–ª addresses.csv –Ω–µ —Å–æ–¥–µ—Ä–∂–∏—Ç –¥–∞–Ω–Ω—ã—Ö
                    </div>
                `;
                return;
            }

            let vipCount = 0;
            let standardCount = 0;

            addresses.forEach(address => {
                const clientType = address.client_type;
                const isVip = clientType === 'VIP';
                
                if (isVip) vipCount++;
                else standardCount++;

                const div = document.createElement('div');
                div.className = `address-item ${isVip ? 'vip' : 'standard'}`;
                div.innerHTML = `
                    <button class="delete-btn" data-address-id="${address.id}" title="–£–¥–∞–ª–∏—Ç—å —Ç–æ—á–∫—É">√ó</button>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" 
                               value="${address.id}" 
                               id="address-${address.id}">
                        <label class="form-check-label" for="address-${address.id}">
                            <div class="address-header">
                                <strong>${address.address}</strong>
                                <span class="badge ${isVip ? 'bg-warning' : 'bg-secondary'}">
                                    ${isVip ? 'VIP' : 'Standard'}
                                </span>
                            </div>
                            <div class="address-details">
                                <small class="text-muted">
                                    ‚è∞ ${address.work_time_start}-${address.work_time_end} | 
                                    üçΩÔ∏è ${address.lunch_start}-${address.lunch_end} |
                                    üìç ${address.visit_duration} –º–∏–Ω
                                </small>
                            </div>
                        </label>
                    </div>
                `;
                container.appendChild(div);
                
                // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∏–∑–º–µ–Ω–µ–Ω–∏—è checkbox
                const checkbox = div.querySelector('input');
                checkbox.addEventListener('change', function() {
                    toggleAddress(address);
                });

                // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–Ω–æ–ø–∫–∏ —É–¥–∞–ª–µ–Ω–∏—è
                const deleteBtn = div.querySelector('.delete-btn');
                deleteBtn.addEventListener('click', function(e) {
                    e.stopPropagation();
                    deleteAddress(address.id);
                });
            });

            // –î–æ–±–∞–≤–ª—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
            const statsDiv = document.createElement('div');
            statsDiv.className = 'mt-3 p-2 bg-light rounded';
            statsDiv.innerHTML = `
                <small class="text-muted">
                    <strong>–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞:</strong> –í—Å–µ–≥–æ: ${addresses.length} | 
                    <span class="text-warning">VIP: ${vipCount}</span> | 
                    <span class="text-secondary">Standard: ${standardCount}</span>
                </small>
            `;
            container.appendChild(statsDiv);

            // –û–±–Ω–æ–≤–ª—è–µ–º —Å—á–µ—Ç—á–∏–∫ –≤—Å–µ—Ö —Ç–æ—á–µ–∫
            document.getElementById('totalAddressesCount').textContent = addresses.length;
        }

        /**
         * –ó–∞–ø–æ–ª–Ω–µ–Ω–∏–µ –≤—ã–ø–∞–¥–∞—é—â–µ–≥–æ —Å–ø–∏—Å–∫–∞ –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è
         * @param {Array} addresses - –ú–∞—Å—Å–∏–≤ –∞–¥—Ä–µ—Å–æ–≤
         */
        function populateDeleteAddressSelect(addresses) {
            const select = document.getElementById('deleteAddressSelect');
            select.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ –∞–¥—Ä–µ—Å –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è</option>';
            
            addresses.forEach(address => {
                const option = document.createElement('option');
                option.value = address.id;
                option.textContent = `${address.address} (${address.client_type})`;
                select.appendChild(option);
            });

            // –û–±–Ω–æ–≤–ª—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∫–Ω–æ–ø–∫–∏ —É–¥–∞–ª–µ–Ω–∏—è
            updateDeleteButtonState();
        }

        /**
         * –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è –∫–Ω–æ–ø–∫–∏ —É–¥–∞–ª–µ–Ω–∏—è
         */
        function updateDeleteButtonState() {
            const select = document.getElementById('deleteAddressSelect');
            const deleteBtn = document.getElementById('deleteAddressBtn');
            deleteBtn.disabled = !select.value;
        }

        /**
         * –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –≤—ã–±–æ—Ä–∞ –∞–¥—Ä–µ—Å–∞
         * @param {Object} address - –û–±—ä–µ–∫—Ç –∞–¥—Ä–µ—Å–∞
         */
        function toggleAddress(address) {
            const checkbox = document.getElementById(`address-${address.id}`);
            
            if (checkbox.checked) {
                if (selectedPoints.size >= MAX_POINTS) {
                    showAlert(`–ú–∞–∫—Å–∏–º—É–º ${MAX_POINTS} —Ç–æ—á–µ–∫ –∑–∞ –æ–¥–∏–Ω —Ä–∞–∑`, 'warning');
                    checkbox.checked = false;
                    return;
                }
                selectedPoints.set(address.id, address);
                
                // –î–æ–±–∞–≤–ª—è–µ–º –º–∞—Ä–∫–µ—Ä –Ω–∞ –∫–∞—Ä—Ç—É
                if (map) {
                    const marker = L.marker([address.lat, address.lon])
                        .addTo(map)
                        .bindPopup(`
                            <strong>${address.address}</strong><br>
                            <span class="badge ${address.client_type === 'VIP' ? 'bg-warning' : 'bg-secondary'}">
                                ${address.client_type === 'VIP' ? 'VIP' : 'Standard'}
                            </span>
                        `);
                    
                    addressMarkers.push({id: address.id, marker: marker});
                }
            } else {
                selectedPoints.delete(address.id);
                // –£–¥–∞–ª—è–µ–º –º–∞—Ä–∫–µ—Ä —Å –∫–∞—Ä—Ç—ã
                const markerIndex = addressMarkers.findIndex(m => m.id === address.id);
                if (markerIndex !== -1) {
                    map.removeLayer(addressMarkers[markerIndex].marker);
                    addressMarkers.splice(markerIndex, 1);
                }
            }
            
            updateSelectionCount();
        }

        /**
         * –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—á–µ—Ç—á–∏–∫–∞ –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö —Ç–æ—á–µ–∫
         */
        function updateSelectionCount() {
            const count = selectedPoints.size;
            document.getElementById('selectedCount').textContent = count;
            document.getElementById('optimizeBtn').disabled = count === 0;
            
            const progress = (count / MAX_POINTS) * 100;
            const progressBar = document.getElementById('selectionProgress');
            progressBar.style.width = `${progress}%`;
            
            if (progress < 50) {
                progressBar.className = 'progress-bar bg-success';
            } else if (progress < 80) {
                progressBar.className = 'progress-bar bg-warning';
            } else {
                progressBar.className = 'progress-bar bg-danger';
            }
        }

        /**
         * –£–¥–∞–ª–µ–Ω–∏–µ —Ç–æ—á–∫–∏
         * @param {number} addressId - ID –∞–¥—Ä–µ—Å–∞ –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è
         */
        async function deleteAddress(addressId) {
            if (!confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç—É —Ç–æ—á–∫—É?')) {
                return;
            }

            try {
                const response = await fetch('/delete_address', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ address_id: addressId })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showAlert(result.message, 'success');
                    
                    // –£–¥–∞–ª—è–µ–º —Ç–æ—á–∫—É –∏–∑ –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö, –µ—Å–ª–∏ –æ–Ω–∞ –±—ã–ª–∞ –≤—ã–±—Ä–∞–Ω–∞
                    if (selectedPoints.has(addressId)) {
                        selectedPoints.delete(addressId);
                        const checkbox = document.getElementById(`address-${addressId}`);
                        if (checkbox) checkbox.checked = false;
                        
                        // –£–¥–∞–ª—è–µ–º –º–∞—Ä–∫–µ—Ä —Å –∫–∞—Ä—Ç—ã
                        const markerIndex = addressMarkers.findIndex(m => m.id === addressId);
                        if (markerIndex !== -1) {
                            map.removeLayer(addressMarkers[markerIndex].marker);
                            addressMarkers.splice(markerIndex, 1);
                        }
                        
                        updateSelectionCount();
                    }
                    
                    // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º —Å–ø–∏—Å–æ–∫ –∞–¥—Ä–µ—Å–æ–≤
                    await reloadAddressesFromServer();
                    
                } else {
                    showAlert('–û—à–∏–±–∫–∞: ' + result.error, 'danger');
                }
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –∞–¥—Ä–µ—Å–∞:', error);
                showAlert('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –∞–¥—Ä–µ—Å–∞: ' + error.message, 'danger');
            }
        }

        /**
         * –£–¥–∞–ª–µ–Ω–∏–µ –≤—Å–µ—Ö –∞–¥—Ä–µ—Å–æ–≤
         */
        async function deleteAllAddresses() {
            if (!confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å –í–°–ï —Ç–æ—á–∫–∏? –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å.')) {
                return;
            }

            try {
                const response = await fetch('/delete_all_addresses', {
                    method: 'POST'
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showAlert(result.message, 'success');
                    
                    // –û—á–∏—â–∞–µ–º –≤—ã–±—Ä–∞–Ω–Ω—ã–µ —Ç–æ—á–∫–∏
                    selectedPoints.clear();
                    document.querySelectorAll('.form-check-input:checked').forEach(cb => cb.checked = false);
                    updateSelectionCount();
                    
                    // –£–¥–∞–ª—è–µ–º –º–∞—Ä–∫–µ—Ä—ã —Å –∫–∞—Ä—Ç—ã
                    addressMarkers.forEach(m => map.removeLayer(m.marker));
                    addressMarkers = [];
                    
                    // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º —Å–ø–∏—Å–æ–∫ –∞–¥—Ä–µ—Å–æ–≤
                    await reloadAddressesFromServer();
                    
                } else {
                    showAlert('–û—à–∏–±–∫–∞: ' + result.error, 'danger');
                }
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –≤—Å–µ—Ö –∞–¥—Ä–µ—Å–æ–≤:', error);
                showAlert('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –≤—Å–µ—Ö –∞–¥—Ä–µ—Å–æ–≤: ' + error.message, 'danger');
            }
        }

        // === –ü–û–°–¢–†–û–ï–ù–ò–ï –ú–ê–†–®–†–£–¢–ê ===
        
        /**
         * –ü–æ—Å—Ç—Ä–æ–µ–Ω–∏–µ –º–∞—Ä—à—Ä—É—Ç–∞ —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º –∞–≤—Ç–æ–º–æ–±–∏–ª—å–Ω—ã—Ö –¥–æ—Ä–æ–≥
         */
        document.getElementById('optimizeBtn').addEventListener('click', async function() {
            if (selectedPoints.size === 0) {
                showAlert('–í—ã–±–µ—Ä–∏—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–Ω—É —Ç–æ—á–∫—É', 'warning');
                return;
            }

            const btn = this;
            const spinner = document.getElementById('optimizeSpinner');
            
            btn.disabled = true;
            spinner.classList.remove('d-none');
            btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> –ü–æ—Å—Ç—Ä–æ–µ–Ω–∏–µ –º–∞—Ä—à—Ä—É—Ç–∞...';
            
            try {
                // –ü–æ–ª—É—á–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –ø–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—è –ø—Ä–æ–±–æ–∫
                const avoidTraffic = document.getElementById('avoidTraffic').checked;
                
                if (avoidTraffic) {
                    showAlert('–ü–æ—Å—Ç—Ä–æ–µ–Ω–∏–µ –º–∞—Ä—à—Ä—É—Ç–∞ —Å —É—á–µ—Ç–æ–º –ø—Ä–æ–±–æ–∫...', 'info');
                } else {
                    showAlert('–ü–æ—Å—Ç—Ä–æ–µ–Ω–∏–µ –º–∞—Ä—à—Ä—É—Ç–∞ –±–µ–∑ —É—á–µ—Ç–∞ –ø—Ä–æ–±–æ–∫...', 'info');
                }
                
                const response = await fetch('/optimize', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        points: Array.from(selectedPoints.keys()),
                        user_location: userLocation,
                        avoid_traffic: avoidTraffic  // –ü–µ—Ä–µ–¥–∞–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫—É –Ω–∞ —Å–µ—Ä–≤–µ—Ä
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    // –°—Ç—Ä–æ–∏–º –º–∞—Ä—à—Ä—É—Ç –ø–æ –∞–≤—Ç–æ–º–æ–±–∏–ª—å–Ω—ã–º –¥–æ—Ä–æ–≥–∞–º
                    await buildCarRoute();
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –∏ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ
                    updateRouteStats({
                        total_points: result.total_points,
                        total_distance: result.total_distance,
                        total_time: result.total_time
                    });
                    
                    // –°–æ–∑–¥–∞–µ–º —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ –∏–∑ –æ—Ç–≤–µ—Ç–∞ —Å–µ—Ä–≤–µ—Ä–∞
                    displaySchedule(result.schedule);
                    
                    document.getElementById('resultsCard').style.display = 'block';
                    
                    showAlert(`–ú–∞—Ä—à—Ä—É—Ç –ø–æ—Å—Ç—Ä–æ–µ–Ω! ${result.total_points} —Ç–æ—á–µ–∫, ${result.total_distance} –∫–º, ${result.total_time} —á`, 'success');
                    
                    // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø—Ä–æ–±–∫–∞—Ö
                    if (result.traffic_info) {
                        displayTrafficInfo(result.traffic_info);
                    } else {
                        document.getElementById('trafficInfo').style.display = 'none';
                    }
                    
                    // –ü—Ä–æ–∫—Ä—É—á–∏–≤–∞–µ–º –∫ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º
                    document.getElementById('resultsCard').scrollIntoView({ 
                        behavior: 'smooth',
                        block: 'start'
                    });
                    
                } else {
                    showAlert('–û—à–∏–±–∫–∞: ' + result.error, 'danger');
                }
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –ø–æ—Å—Ç—Ä–æ–µ–Ω–∏—è –º–∞—Ä—à—Ä—É—Ç–∞:', error);
                showAlert('–û—à–∏–±–∫–∞ –ø–æ—Å—Ç—Ä–æ–µ–Ω–∏—è –º–∞—Ä—à—Ä—É—Ç–∞: ' + error.message, 'danger');
            } finally {
                btn.disabled = false;
                spinner.classList.add('d-none');
                btn.innerHTML = 'üöÄ –ü–æ—Å—Ç—Ä–æ–∏—Ç—å –æ–ø—Ç–∏–º–∞–ª—å–Ω—ã–π –º–∞—Ä—à—Ä—É—Ç';
            }
        });

        /**
         * –ü–æ—Å—Ç—Ä–æ–µ–Ω–∏–µ –∞–≤—Ç–æ–º–æ–±–∏–ª—å–Ω–æ–≥–æ –º–∞—Ä—à—Ä—É—Ç–∞ —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º OSRM
         * @returns {Promise} –ü—Ä–æ–º–∏—Å –ø–æ—Å—Ç—Ä–æ–µ–Ω–∏—è –º–∞—Ä—à—Ä—É—Ç–∞
         */
        function buildCarRoute() {
            return new Promise((resolve, reject) => {
                // –û—á–∏—â–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–π –º–∞—Ä—à—Ä—É—Ç
                if (routingControl) {
                    map.removeControl(routingControl);
                }
                
                if (routeLayer) {
                    map.removeLayer(routeLayer);
                }
                
                // –£–¥–∞–ª—è–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–µ –º–∞—Ä–∫–µ—Ä—ã –≤—ã–±–æ—Ä–∞
                addressMarkers.forEach(m => map.removeLayer(m.marker));
                addressMarkers = [];

                // –°–æ–∑–¥–∞–µ–º —Ç–æ—á–∫–∏ –º–∞—Ä—à—Ä—É—Ç–∞
                const waypoints = Array.from(selectedPoints.values()).map(address => 
                    L.latLng(address.lat, address.lon)
                );

                // –î–æ–±–∞–≤–ª—è–µ–º —Å—Ç–∞—Ä—Ç–æ–≤—É—é —Ç–æ—á–∫—É (–º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è) –≤ –Ω–∞—á–∞–ª–æ
                waypoints.unshift(L.latLng(userLocation[0], userLocation[1]));

                // –°–æ–∑–¥–∞–µ–º –º–∞—Ä—à—Ä—É—Ç —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º OSRM (Open Source Routing Machine)
                routingControl = L.Routing.control({
                    waypoints: waypoints,
                    routeWhileDragging: false,
                    show: false,
                    showAlternatives: false,
                    lineOptions: {
                        styles: [{color: '#1e88e5', weight: 6, opacity: 0.8}]
                    },
                    createMarker: function(i, waypoint, n) {
                        if (i === 0) {
                            // –°—Ç–∞—Ä—Ç–æ–≤–∞—è —Ç–æ—á–∫–∞ - –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                            return L.marker(waypoint.latLng, {
                                icon: L.divIcon({
                                    html: '<div class="custom-marker" style="border-color: #4CAF50; color: white; background: #4CAF50">üöó</div>',
                                    iconSize: [30, 30],
                                    className: 'custom-marker'
                                })
                            }).bindPopup('üìç <strong>–í–∞—à–µ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ</strong><br>–ù–∞—á–∞–ª–æ –º–∞—Ä—à—Ä—É—Ç–∞');
                        } else {
                            // –û—Å—Ç–∞–ª—å–Ω—ã–µ —Ç–æ—á–∫–∏
                            const address = Array.from(selectedPoints.values())[i-1];
                            return L.marker(waypoint.latLng, {
                                icon: L.divIcon({
                                    html: `<div class="custom-marker" style="border-color: ${address.client_type === 'VIP' ? '#FF9800' : '#1e88e5'}; color: black; background: white">${i}</div>`,
                                    iconSize: [30, 30],
                                    className: 'custom-marker'
                                })
                            }).bindPopup(`
                                <strong>${address.address}</strong><br>
                                <span class="badge ${address.client_type === 'VIP' ? 'bg-warning' : 'bg-secondary'}">
                                    ${address.client_type === 'VIP' ? 'VIP' : 'Standard'}
                                </span><br>
                                ‚è∞ ${address.work_time_start}-${address.work_time_end}<br>
                                üçΩÔ∏è ${address.lunch_start}-${address.lunch_end}
                            `);
                        }
                    },
                    router: L.Routing.osrmv1({
                        serviceUrl: 'https://router.project-osrm.org/route/v1'
                    })
                }).addTo(map);

                // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –ø–æ—Å—Ç—Ä–æ–µ–Ω–∏—è –º–∞—Ä—à—Ä—É—Ç–∞
                routingControl.on('routesfound', function(e) {
                    const routes = e.routes;
                    if (routes && routes.length > 0) {
                        const route = routes[0];
                        const totalDistance = (route.summary.totalDistance / 1000).toFixed(1);
                        const totalTime = (route.summary.totalTime / 3600).toFixed(1);
                        
                        // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
                        updateRouteStats({
                            total_points: selectedPoints.size,
                            total_distance: totalDistance,
                            total_time: totalTime
                        });
                        
                        // –°–æ–∑–¥–∞–µ–º —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ
                        const schedule = createSchedule(Array.from(selectedPoints.values()));
                        displaySchedule(schedule);
                        
                        document.getElementById('resultsCard').style.display = 'block';
                        
                        showAlert(`–ú–∞—Ä—à—Ä—É—Ç –ø–æ—Å—Ç—Ä–æ–µ–Ω! ${selectedPoints.size} —Ç–æ—á–µ–∫, ${totalDistance} –∫–º, ${totalTime} —á`, 'success');
                        
                        // –ü—Ä–æ–∫—Ä—É—á–∏–≤–∞–µ–º –∫ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º
                        document.getElementById('resultsCard').scrollIntoView({ 
                            behavior: 'smooth',
                            block: 'start'
                        });
                        
                        resolve();
                    } else {
                        reject(new Error('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ—Å—Ç—Ä–æ–∏—Ç—å –º–∞—Ä—à—Ä—É—Ç'));
                    }
                });

                // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –æ—à–∏–±–æ–∫
                routingControl.on('routingerror', function(e) {
                    reject(new Error('–û—à–∏–±–∫–∞ –ø–æ—Å—Ç—Ä–æ–µ–Ω–∏—è –º–∞—Ä—à—Ä—É—Ç–∞: ' + e.error.message));
                });
            });
        }

        /**
         * –°–æ–∑–¥–∞–Ω–∏–µ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è –ø–æ—Å–µ—â–µ–Ω–∏–π
         * @param {Array} addresses - –ú–∞—Å—Å–∏–≤ –∞–¥—Ä–µ—Å–æ–≤
         * @returns {Array} –ú–∞—Å—Å–∏–≤ –æ–±—ä–µ–∫—Ç–æ–≤ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è
         */
        function createSchedule(addresses) {
            const schedule = [];
            let currentTime = new Date();
            currentTime.setHours(9, 0, 0, 0); // –ù–∞—á–∏–Ω–∞–µ–º –≤ 9:00

            addresses.forEach((address, index) => {
                const arrivalTime = new Date(currentTime);
                const departureTime = new Date(arrivalTime);
                
                // –î–æ–±–∞–≤–ª—è–µ–º –≤—Ä–µ–º—è –Ω–∞ –¥–æ—Ä–æ–≥—É (–ø—Ä–∏–º–µ—Ä–Ω–æ 30 –º–∏–Ω—É—Ç –º–µ–∂–¥—É —Ç–æ—á–∫–∞–º–∏)
                if (index > 0) {
                    arrivalTime.setMinutes(arrivalTime.getMinutes() + 30);
                }
                
                // –í—Ä–µ–º—è –ø–æ—Å–µ—â–µ–Ω–∏—è (45 –º–∏–Ω—É—Ç –¥–ª—è VIP, 30 –¥–ª—è —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã—Ö)
                const visitDuration = address.client_type === 'VIP' ? 45 : 30;
                departureTime.setMinutes(arrivalTime.getMinutes() + visitDuration);
                
                schedule.push({
                    date: new Date().toLocaleDateString('ru-RU'),
                    order: index + 1,
                    arrival_time: arrivalTime.toLocaleTimeString('ru-RU', {hour: '2-digit', minute: '2-digit'}),
                    departure_time: departureTime.toLocaleTimeString('ru-RU', {hour: '2-digit', minute: '2-digit'}),
                    address: address.address,
                    client_type: address.client_type,
                    duration: visitDuration.toString(),
                    lunch_time: `${address.lunch_start}-${address.lunch_end}`
                });
                
                // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–µ–∫—É—â–µ–µ –≤—Ä–µ–º—è –¥–ª—è —Å–ª–µ–¥—É—é—â–µ–π —Ç–æ—á–∫–∏
                currentTime = new Date(departureTime);
            });

            return schedule;
        }

        /**
         * –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è –≤ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–µ
         * @param {Array} schedule - –ú–∞—Å—Å–∏–≤ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è
         */
        function displaySchedule(schedule) {
            const container = document.getElementById('schedule');
            container.innerHTML = '';

            if (schedule.length === 0) {
                container.innerHTML = `
                    <div class="text-center text-muted py-4">
                        <div style="font-size: 48px;">üìÖ</div>
                        <p>–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è</p>
                    </div>
                `;
                return;
            }

            let currentDate = '';
            
            schedule.forEach(item => {
                if (item.date !== currentDate) {
                    currentDate = item.date;
                    const dateHeader = document.createElement('div');
                    dateHeader.className = 'schedule-date-header';
                    dateHeader.innerHTML = `
                        <div class="text-center bg-primary text-white py-2 mb-2 rounded">
                            <strong>üìÖ ${currentDate}</strong>
                        </div>
                    `;
                    container.appendChild(dateHeader);
                }

                const div = document.createElement('div');
                div.className = `schedule-item ${item.client_type?.toLowerCase()}`;
                div.innerHTML = `
                    <div class="schedule-order">${item.order}</div>
                    <div class="schedule-content">
                        <div class="schedule-time">
                            <strong>${item.arrival_time} - ${item.departure_time}</strong>
                        </div>
                        <div class="schedule-address">${item.address}</div>
                        <div class="schedule-meta">
                            <span class="duration">${item.duration} –º–∏–Ω</span>
                            <span class="badge ${item.client_type === 'VIP' ? 'bg-warning' : 'bg-secondary'}">
                                ${item.client_type === 'VIP' ? 'VIP' : 'Standard'}
                            </span>
                            <small class="text-muted ms-2">
                                üçΩÔ∏è ${item.lunch_time}
                            </small>
                        </div>
                    </div>
                `;
                container.appendChild(div);
            });
        }

        /**
         * –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –º–∞—Ä—à—Ä—É—Ç–∞
         * @param {Object} result - –†–µ–∑—É–ª—å—Ç–∞—Ç —Å –¥–∞–Ω–Ω—ã–º–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
         */
        function updateRouteStats(result) {
            document.getElementById('totalPoints').textContent = result.total_points;
            document.getElementById('totalDistance').textContent = result.total_distance;
            document.getElementById('totalTime').textContent = result.total_time;
        }

        /**
         * –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –ø—Ä–æ–±–∫–∞—Ö
         * @param {Object} trafficInfo - –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø—Ä–æ–±–∫–∞—Ö
         */
        function displayTrafficInfo(trafficInfo) {
            const trafficDiv = document.getElementById('trafficInfo');
            const detailsDiv = document.getElementById('trafficDetails');
            
            if (trafficInfo) {
                let html = '';
                
                // –û—Å–Ω–æ–≤–Ω–æ–π —Å—Ç–∞—Ç—É—Å
                if (trafficInfo.has_traffic || trafficInfo.has_incidents) {
                    html += `<div class="traffic-status mb-3">
                        <div class="alert ${trafficInfo.level === 'very_high' ? 'alert-danger' : 
                                         trafficInfo.level === 'high' ? 'alert-warning' : 
                                         trafficInfo.level === 'medium' ? 'alert-info' : 'alert-success'}">
                            <strong>üö¶ –î–æ—Ä–æ–∂–Ω–∞—è —Å–∏—Ç—É–∞—Ü–∏—è:</strong><br>
                            ${trafficInfo.has_traffic ? 'üî¥ –û–±–Ω–∞—Ä—É–∂–µ–Ω—ã –ø—Ä–æ–±–∫–∏' : 'üü¢ –ü—Ä–æ–±–æ–∫ –Ω–µ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–æ'}<br>
                            ${trafficInfo.has_incidents ? 'üöß –û–±–Ω–∞—Ä—É–∂–µ–Ω—ã –¥–æ—Ä–æ–∂–Ω—ã–µ –∏–Ω—Ü–∏–¥–µ–Ω—Ç—ã' : '‚úÖ –î–¢–ü –∏ –ø–µ—Ä–µ–∫—Ä—ã—Ç–∏–π –Ω–µ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–æ'}
                        </div>
                    </div>`;
                }
                
                // –î–µ—Ç–∞–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è
                html += `<div class="traffic-details">`;
                
                if (trafficInfo.details && trafficInfo.details.length > 0) {
                    html += `<h6>üìä –î–µ—Ç–∞–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è:</h6>`;
                    trafficInfo.details.forEach(detail => {
                        html += `<div class="traffic-detail-item">‚Ä¢ ${detail}</div>`;
                    });
                }
                
                // –í–ª–∏—è–Ω–∏–µ –Ω–∞ –º–∞—Ä—à—Ä—É—Ç
                if (trafficInfo.traffic_impact) {
                    html += `<div class="traffic-impact mt-2 p-2 bg-light rounded">
                        <strong>‚è±Ô∏è –í–ª–∏—è–Ω–∏–µ –Ω–∞ –º–∞—Ä—à—Ä—É—Ç:</strong> –í—Ä–µ–º—è –≤ –ø—É—Ç–∏ —É–≤–µ–ª–∏—á–µ–Ω–æ –Ω–∞ ${trafficInfo.traffic_impact}
                    </div>`;
                }
                
                html += `</div>`;
                
                detailsDiv.innerHTML = html;
                trafficDiv.style.display = 'block';
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
                if (trafficInfo.has_traffic) {
                    showAlert(`üö¶ –û–±–Ω–∞—Ä—É–∂–µ–Ω—ã –ø—Ä–æ–±–∫–∏! –£—Ä–æ–≤–µ–Ω—å: ${getTrafficLevelText(trafficInfo.level)}`, 
                             trafficInfo.level === 'very_high' ? 'danger' : 'warning');
                } else {
                    showAlert('üü¢ –ü—Ä–æ–±–æ–∫ –Ω–µ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–æ, –¥–≤–∏–∂–µ–Ω–∏–µ —Å–≤–æ–±–æ–¥–Ω–æ–µ', 'success');
                }
                
            } else {
                trafficDiv.style.display = 'none';
            }
        }

        // === –≠–ö–°–ü–û–†–¢ –î–ê–ù–ù–´–• ===
        
        /**
         * –≠–∫—Å–ø–æ—Ä—Ç —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è –≤ CSV
         */
        document.getElementById('exportBtn').addEventListener('click', function() {
            const scheduleItems = document.querySelectorAll('.schedule-item');
            
            if (scheduleItems.length === 0) {
                showAlert('–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞', 'warning');
                return;
            }

            let csvContent = "–î–∞—Ç–∞;–ü–æ—Ä—è–¥–æ–∫;–í—Ä–µ–º—è –ø—Ä–∏–±—ã—Ç–∏—è;–í—Ä–µ–º—è —É–±—ã—Ç–∏—è;–ê–¥—Ä–µ—Å;–¢–∏–ø –∫–ª–∏–µ–Ω—Ç–∞;–î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å;–û–±–µ–¥–µ–Ω–Ω–æ–µ –≤—Ä–µ–º—è\n";
            
            let currentDate = '';
            scheduleItems.forEach(item => {
                const dateHeader = item.previousElementSibling;
                if (dateHeader && dateHeader.classList.contains('schedule-date-header')) {
                    const dateMatch = dateHeader.textContent.match(/\d{2}\.\d{2}\.\d{4}/);
                    if (dateMatch) {
                        currentDate = dateMatch[0];
                    }
                }
                
                const order = item.querySelector('.schedule-order').textContent;
                const arrival = item.querySelector('.schedule-time strong').textContent.split(' - ')[0];
                const departure = item.querySelector('.schedule-time strong').textContent.split(' - ')[1];
                const address = item.querySelector('.schedule-address').textContent;
                const clientType = item.querySelector('.badge').textContent;
                const duration = item.querySelector('.duration').textContent;
                const lunchTime = item.querySelector('.text-muted').textContent.replace('üçΩÔ∏è ', '');
                
                csvContent += `"${currentDate}";"${order}";"${arrival}";"${departure}";"${address}";"${clientType}";"${duration}";"${lunchTime}"\n`;
            });
            
            const blob = new Blob(["\uFEFF" + csvContent], { type: 'text/csv;charset=utf-8;' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `–º–∞—Ä—à—Ä—É—Ç_${new Date().toLocaleDateString('ru-RU')}.csv`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
            
            showAlert('–ú–∞—Ä—à—Ä—É—Ç —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω –≤ CSV —Ñ–∞–π–ª', 'success');
        });

        // === –§–ò–õ–¨–¢–†–ê–¶–ò–Ø –ò –ü–û–ò–°–ö ===
        
        /**
         * –ü–æ–∏—Å–∫ –∞–¥—Ä–µ—Å–æ–≤ –≤ —Å–ø–∏—Å–∫–µ
         */
        document.getElementById('addressSearch').addEventListener('input', function(e) {
            const searchTerm = e.target.value.toLowerCase().trim();
            const addressItems = document.querySelectorAll('.address-item');
            
            addressItems.forEach(item => {
                const text = item.textContent.toLowerCase();
                item.style.display = text.includes(searchTerm) ? 'block' : 'none';
            });
        });

        /**
         * –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ø–æ —Ç–∏–ø—É –∫–ª–∏–µ–Ω—Ç–∞
         */
        document.getElementById('clientTypeFilter').addEventListener('change', function(e) {
            const filter = e.target.value;
            const addressItems = document.querySelectorAll('.address-item');
            
            addressItems.forEach(item => {
                if (filter === 'all') {
                    item.style.display = 'block';
                } else {
                    const isVip = item.classList.contains('vip');
                    const shouldShow = (filter === 'vip' && isVip) || (filter === 'standard' && !isVip);
                    item.style.display = shouldShow ? 'block' : 'none';
                }
            });
        });

        // === –ò–ú–ü–û–†–¢ –î–ê–ù–ù–´–• ===
        
        /**
         * –ó–∞–≥—Ä—É–∑–∫–∞ CSV —Ñ–∞–π–ª–∞ —Å –∞–¥—Ä–µ—Å–∞–º–∏
         */
        document.getElementById('uploadCsvBtn').addEventListener('click', async function() {
            const fileInput = document.getElementById('csvFile');
            const file = fileInput.files[0];
            
            if (!file) {
                showAlert('–í—ã–±–µ—Ä–∏—Ç–µ CSV —Ñ–∞–π–ª', 'warning');
                return;
            }
            
            const btn = this;
            const originalText = btn.innerHTML;
            btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> –ó–∞–≥—Ä—É–∑–∫–∞...';
            btn.disabled = true;
            
            try {
                const formData = new FormData();
                formData.append('csv_file', file);
                
                const response = await fetch('/upload_addresses', {
                    method: 'POST',
                    body: formData
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showAlert(result.message, 'success');
                    document.getElementById('importStatus').innerHTML = `
                        <div class="alert alert-success">
                            <strong>‚úÖ –£—Å–ø–µ—à–Ω–æ!</strong><br>
                            ${result.message}<br>
                            –í—Å–µ–≥–æ –∞–¥—Ä–µ—Å–æ–≤: ${result.total_addresses}
                            ${result.backup_created ? '<br><small>–°–æ–∑–¥–∞–Ω –±—ç–∫–∞–ø –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ —Ñ–∞–π–ª–∞</small>' : ''}
                        </div>
                    `;
                    
                    // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º —Å–ø–∏—Å–æ–∫ –∞–¥—Ä–µ—Å–æ–≤
                    await loadAddresses();
                    
                    // –û—á–∏—â–∞–µ–º –ø–æ–ª–µ
                    fileInput.value = '';
                    
                } else {
                    showAlert('–û—à–∏–±–∫–∞: ' + result.error, 'danger');
                    document.getElementById('importStatus').innerHTML = `
                        <div class="alert alert-danger">
                            <strong>‚ùå –û—à–∏–±–∫–∞:</strong> ${result.error}
                        </div>
                    `;
                }
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–∞:', error);
                showAlert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–∞: ' + error.message, 'danger');
            } finally {
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        });

        /**
         * –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –æ–¥–Ω–æ–π —Ç–æ—á–∫–∏
         */
        document.getElementById('addSingleAddressBtn').addEventListener('click', async function() {
            const address = document.getElementById('newAddress').value.trim();
            const lat = parseFloat(document.getElementById('newLat').value);
            const lon = parseFloat(document.getElementById('newLon').value);
            const clientType = document.getElementById('newClientType').value;
            
            if (!address) {
                showAlert('–í–≤–µ–¥–∏—Ç–µ –∞–¥—Ä–µ—Å', 'warning');
                return;
            }
            
            if (isNaN(lat) || isNaN(lon)) {
                showAlert('–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã', 'warning');
                return;
            }
            
            const btn = this;
            const originalText = btn.innerHTML;
            btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> –î–æ–±–∞–≤–ª–µ–Ω–∏–µ...';
            btn.disabled = true;
            
            try {
                const response = await fetch('/add_single_address', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        address: address,
                        lat: lat,
                        lon: lon,
                        client_type: clientType,
                        work_time_start: '09:00',
                        work_time_end: '18:00',
                        lunch_start: '13:00',
                        lunch_end: '14:00'
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showAlert(result.message, 'success');
                    document.getElementById('importStatus').innerHTML = `
                        <div class="alert alert-success">
                            <strong>‚úÖ –£—Å–ø–µ—à–Ω–æ!</strong><br>
                            ${result.message}<br>
                            –í—Å–µ–≥–æ –∞–¥—Ä–µ—Å–æ–≤: ${result.total_addresses}
                        </div>
                    `;
                    
                    // –û—á–∏—â–∞–µ–º —Ñ–æ—Ä–º—É
                    document.getElementById('newAddress').value = '';
                    document.getElementById('newLat').value = '';
                    document.getElementById('newLon').value = '';
                    
                    // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º —Å–ø–∏—Å–æ–∫ –∞–¥—Ä–µ—Å–æ–≤ –∏–∑ —Å–µ—Ä–≤–µ—Ä–∞
                    await reloadAddressesFromServer();
                    
                } else {
                    showAlert('–û—à–∏–±–∫–∞: ' + result.error, 'danger');
                    document.getElementById('importStatus').innerHTML = `
                        <div class="alert alert-danger">
                            <strong>‚ùå –û—à–∏–±–∫–∞:</strong> ${result.error}
                        </div>
                    `;
                }
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∞–¥—Ä–µ—Å–∞:', error);
                showAlert('–û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∞–¥—Ä–µ—Å–∞: ' + error.message, 'danger');
            } finally {
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        });

        /**
         * –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∞ –∞–¥—Ä–µ—Å–æ–≤ —Å —Å–µ—Ä–≤–µ—Ä–∞
         */
        async function reloadAddressesFromServer() {
            try {
                // –ü–æ–ª—É—á–∞–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–π —Å–ø–∏—Å–æ–∫ –∞–¥—Ä–µ—Å–æ–≤ —Å —Å–µ—Ä–≤–µ—Ä–∞
                const response = await fetch('/get_addresses');
                if (!response.ok) {
                    throw new Error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∞–¥—Ä–µ—Å–æ–≤ —Å —Å–µ—Ä–≤–µ—Ä–∞');
                }
                
                const addresses = await response.json();
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –ª–æ–∫–∞–ª—å–Ω—ã–π –º–∞—Å—Å–∏–≤ –∞–¥—Ä–µ—Å–æ–≤
                allAddresses = addresses;
                
                // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ –≤ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–µ
                populateAddressList(addresses);
                populateDeleteAddressSelect(addresses);
                updateFileInfo(addresses.length);
                
                console.log('‚úÖ –ê–¥—Ä–µ—Å—ã –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∂–µ–Ω—ã —Å —Å–µ—Ä–≤–µ—Ä–∞:', addresses.length);
                
            } catch (error) {
                console.error('‚ùå –û—à–∏–±–∫–∞ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∏ –∞–¥—Ä–µ—Å–æ–≤:', error);
                showAlert('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å–ø–∏—Å–∫–∞ –∞–¥—Ä–µ—Å–æ–≤', 'danger');
            }
        }

        /**
         * –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∫–ª–∏–∫–∞ –ø–æ –∫–∞—Ä—Ç–µ –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç
         */
        function setupMapClickForNewAddress() {
            if (map) {
                map.on('click', function(e) {
                    document.getElementById('newLat').value = e.latlng.lat.toFixed(6);
                    document.getElementById('newLon').value = e.latlng.lng.toFixed(6);
                    showAlert('–ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã –ø–æ –∫–ª–∏–∫—É –Ω–∞ –∫–∞—Ä—Ç–µ', 'info');
                });
            }
        }

        // === –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø –ü–†–ò–õ–û–ñ–ï–ù–ò–Ø ===
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üöÄ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è —Å Leaflet...');
            initMap();
            loadAddresses();
            
            // –ù–∞–∑–Ω–∞—á–∞–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏
            document.getElementById('updateLocationBtn').addEventListener('click', getUserLocation);
            document.getElementById('clearSelectionBtn').addEventListener('click', function() {
                selectedPoints.clear();
                document.querySelectorAll('.form-check-input:checked').forEach(cb => cb.checked = false);
                updateSelectionCount();
                
                // –£–¥–∞–ª—è–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–µ –º–∞—Ä–∫–µ—Ä—ã
                addressMarkers.forEach(m => map.removeLayer(m.marker));
                addressMarkers = [];
                
                // –£–¥–∞–ª—è–µ–º –º–∞—Ä—à—Ä—É—Ç
                if (routingControl) {
                    map.removeControl(routingControl);
                    routingControl = null;
                }
                if (routeLayer) {
                    map.removeLayer(routeLayer);
                    routeLayer = null;
                }
                
                showAlert('–í—ã–±–æ—Ä –æ—á–∏—â–µ–Ω', 'info');
            });

            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è —Ç–æ—á–µ–∫
            document.getElementById('deleteAddressSelect').addEventListener('change', updateDeleteButtonState);
            document.getElementById('deleteAddressBtn').addEventListener('click', function() {
                const select = document.getElementById('deleteAddressSelect');
                const addressId = parseInt(select.value);
                if (addressId) {
                    deleteAddress(addressId);
                }
            });
            document.getElementById('deleteAllAddressesBtn').addEventListener('click', deleteAllAddresses);

            // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∫–ª–∏–∫–∞ –ø–æ –∫–∞—Ä—Ç–µ –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç
            setupMapClickForNewAddress();
        });
    </script>
</body>
</html>